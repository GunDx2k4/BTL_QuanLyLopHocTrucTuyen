@model BTL_QuanLyLopHocTrucTuyen.Models.Assignment

@{
    ViewData["Title"] = "Nộp bài tập";
    var assignment = ViewBag.Assignment as BTL_QuanLyLopHocTrucTuyen.Models.Assignment;
    var existingSubmission = ViewBag.ExistingSubmission as BTL_QuanLyLopHocTrucTuyen.Models.Submission;
    var timeRemaining = (TimeSpan?)ViewBag.TimeRemaining;
    var isOverdue = (bool?)ViewBag.IsOverdue ?? false;

    // Helper function to get filename from URL
    Func<string, string> GetFileName = (url) =>
    {
        if (string.IsNullOrEmpty(url)) return "file";
        var parts = url.Split('/');
        return parts[parts.Length - 1];
    };
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Student")">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Assignments", "Student")">Bài tập</a></li>
            <li class="breadcrumb-item active">Nộp bài tập</li>
        </ol>
    </nav>

    <!-- Alert -->
    <div class="row mb-4">
        <div class="col-12">
            @if (isOverdue)
            {
                <div class="alert alert-danger">
                    <h5 class="alert-heading">⚠️ Bài tập đã quá hạn!</h5>
                    <p class="mb-0">Bạn vẫn có thể nộp nhưng có thể bị trừ điểm.</p>
                </div>
            }
            else if (timeRemaining.HasValue && timeRemaining.Value.TotalDays < 2)
            {
                <div class="alert alert-warning">
                    <h5 class="alert-heading">⏰ Sắp đến hạn!</h5>
                    <p class="mb-0">Còn <strong>@((int)timeRemaining.Value.TotalDays) ngày @timeRemaining.Value.Hours giờ</strong></p>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <h5>📝 Hướng dẫn nộp bài</h5>
                    <ul class="mb-0">
                        <li>File phải đúng định dạng (zip, pdf, doc...)</li>
                        <li>Kích thước tối đa 50MB</li>
                        <li>Có thể nộp lại trước hạn chót</li>
                    </ul>
                </div>
            }
        </div>
    </div>

    <!-- Assignment Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">📝 Thông tin bài tập</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>@Model.Title</h5>
                            <p class="mb-2"><strong>📚 Khóa học:</strong> @(Model.Lesson?.Course?.Name ?? "N/A")</p>
                            <p class="mb-2"><strong>👨‍🏫 Giảng viên:</strong> @(Model.Lesson?.Course?.Instructor?.FullName ?? "N/A")</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="mb-2">
                                <strong>⏰ Hạn nộp:</strong>
                                <span class="badge @(isOverdue ? "bg-danger" : "bg-warning") fs-6">
                                    @Model.DueDate.ToString("dd/MM/yyyy HH:mm")
                                </span>
                            </p>
                            @if (!isOverdue && timeRemaining.HasValue)
                            {
                                <p class="mb-2">
                                    <strong>⏳ Còn lại:</strong>
                                    <span class="text-danger fw-bold">@((int)timeRemaining.Value.TotalDays) ngày @timeRemaining.Value.Hours giờ</span>
                                </p>
                            }
                            <p class="mb-0">
                                <strong>📊 Trạng thái:</strong>
                                <span class="badge @(existingSubmission != null ? "bg-success" : "bg-warning")">
                                    @(existingSubmission != null ? "Đã nộp" : "Chưa nộp")
                                </span>
                            </p>
                        </div>
                    </div>
                    <hr>
                    <h6>📋 Yêu cầu:</h6>
                    <div class="bg-light p-3 rounded">
                        <p class="mb-0">@(Model.Description ?? "Không có mô tả")</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Previous Submission -->
    @if (existingSubmission != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">📜 Bài đã nộp trước đó</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>📅 Ngày nộp:</strong> @existingSubmission.SubmittedAt.ToString("dd/MM/yyyy HH:mm")</p>
                        <p class="mb-2"><strong>📎 File:</strong> @GetFileName(existingSubmission.FileUrl)</p>
                        @if (existingSubmission.Grade.HasValue)
                        {
                            <p class="mb-0"><strong>🎯 Điểm:</strong> @existingSubmission.Grade.Value.ToString("0.0")/10</p>
                        }
                        <div class="alert alert-warning mt-2 mb-0">
                            <strong>⚠️ Lưu ý:</strong> Nộp lại sẽ thay thế file cũ!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Submit Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">📤 @(existingSubmission != null ? "Nộp lại bài" : "Nộp bài")</h4>
                </div>
                <div class="card-body">
                    <form asp-action="SubmitAssignment"
                          asp-controller="Student"
                          method="post"
                          enctype="multipart/form-data"
                          id="submitForm">

                        <input type="hidden" name="assignmentId" value="@Model.Id" />

                        <!-- File Upload -->
                        <div class="mb-4">
                            <label for="file" class="form-label fw-bold">
                                📎 File nộp bài <span class="text-danger">*</span>
                            </label>
                            <input class="form-control form-control-lg"
                                   type="file"
                                   id="file"
                                   name="file"
                                   required
                                   accept=".zip,.rar,.7z,.pdf,.doc,.docx"
                                   onchange="previewFile(this)">
                            <div class="form-text">Định dạng: zip, rar, pdf, doc, docx (Max 50MB)</div>
                            <div id="fileInfo" class="alert alert-info mt-2" style="display: none;">
                                <p class="mb-1"><strong>📄 File:</strong> <span id="fileName"></span></p>
                                <p class="mb-0"><strong>📦 Size:</strong> <span id="fileSize"></span></p>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label for="notes" class="form-label fw-bold">📝 Ghi chú (Tùy chọn)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="4"
                                      placeholder="Ghi chú cho giảng viên..."></textarea>
                        </div>

                        <!-- Checkbox -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmCheck" required>
                                <label class="form-check-label" for="confirmCheck">
                                    Tôi xác nhận đây là bài làm của mình
                                </label>
                            </div>
                        </div>

                        <!-- Messages -->
                        @if (TempData["Success"] != null)
                        {
                            <div class="alert alert-success">@TempData["Success"]</div>
                        }
                        @if (TempData["Error"] != null)
                        {
                            <div class="alert alert-danger">@TempData["Error"]</div>
                        }

                        <!-- Buttons -->
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Assignments", "Student")" class="btn btn-secondary btn-lg">❌ Hủy</a>
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                ✅ @(existingSubmission != null ? "Nộp lại" : "Nộp bài")
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function previewFile(input) {
            var file = input.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileInfo').style.display = 'block';

                if (file.size > 50 * 1024 * 1024) {
                    alert('⚠️ File quá lớn! Max 50MB.');
                    input.value = '';
                    document.getElementById('fileInfo').style.display = 'none';
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        document.getElementById('submitForm').addEventListener('submit', function(e) {
            var submitBtn = document.getElementById('submitBtn');
            var file = document.getElementById('file').files[0];

            if (!file) {
                e.preventDefault();
                alert('⚠️ Vui lòng chọn file!');
                return false;
            }

            if (!document.getElementById('confirmCheck').checked) {
                e.preventDefault();
                alert('⚠️ Vui lòng tick xác nhận!');
                return false;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang nộp...';
            return true;
        });
    </script>
}