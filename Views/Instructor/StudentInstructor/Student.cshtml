@model IEnumerable<dynamic>
@using BTL_QuanLyLopHocTrucTuyen.Models.Enums

@{
    ViewData["Title"] = "Qu·∫£n l√Ω h·ªçc vi√™n";
    Layout = "~/Views/Instructor/Shared/_InstructorLayout.cshtml";
}

<link rel="stylesheet" href="~/css/Instructor/Student/Student.css" asp-append-version="true" />

<div class="content-main student-page">

    <!-- üîπ Header -->
    <div class="header-student d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-primary mb-0">
            <i class="bi bi-people-fill me-2"></i>Danh s√°ch h·ªçc vi√™n
        </h4>
    </div>

    <!-- üîπ B·ªô l·ªçc -->
    <div class="filter-bar d-flex flex-wrap gap-2 mb-4">
        <div class="filter-course position-relative" style="min-width:260px;">
            <div class="input-wrapper position-relative">
                <input type="text" id="courseSearch" class="form-control pe-5"
                       placeholder="T√¨m ho·∫∑c ch·ªçn kh√≥a h·ªçc..." autocomplete="off"
                       value="@ViewBag.CurrentCourseName">
                <button type="button" id="clearCourse" class="btn-clear" title="X√≥a l·ª±a ch·ªçn">&times;</button>
            </div>

            <ul id="courseDropdown"
                class="list-group position-absolute w-100 shadow-sm bg-white border"
                style="display:none; z-index:1050; max-height:240px; overflow-y:auto;">
                @foreach (var course in ViewBag.Courses)
                {
                    <li class="list-group-item list-group-item-action @(course.Id == ViewBag.CurrentCourseId ? "active" : "")"
                        data-id="@course.Id">@course.Name</li>
                }
            </ul>
        </div>

        <select id="statusFilter" name="status" class="form-select form-select-sm" style="width:200px;">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="ƒêang h·ªçc" selected="@(ViewBag.SelectedStatus == "ƒêang h·ªçc")">ƒêang h·ªçc</option>
            <option value="Ho√†n th√†nh" selected="@(ViewBag.SelectedStatus == "Ho√†n th√†nh")">Ho√†n th√†nh</option>
            <option value="Ngh·ªâ h·ªçc" selected="@(ViewBag.SelectedStatus == "Ngh·ªâ h·ªçc")">Ngh·ªâ h·ªçc</option>
        </select>
    </div>

    <!-- üîπ Th·ªëng k√™ nhanh -->
    <div class="overview-grid mb-4">
        <div class="stat-card bg-blue">
            <i class="bi bi-mortarboard-fill"></i>
            <div>
                <p class="label">T·ªïng h·ªçc vi√™n</p>
                <h5 class="value" id="totalStudents">@ViewBag.TotalStudents</h5>
            </div>
        </div>
        <div class="stat-card bg-green">
            <i class="bi bi-person-check-fill"></i>
            <div>
                <p class="label">ƒêang h·ªçc</p>
                <h5 class="value" id="activeCount">@ViewBag.ActiveCount</h5>
            </div>
        </div>
        <div class="stat-card bg-orange">
            <i class="bi bi-person-x-fill"></i>
            <div>
                <p class="label">Ngh·ªâ h·ªçc</p>
                <h5 class="value" id="quitCount">@ViewBag.QuitCount</h5>
            </div>
        </div>
    </div>

    <!-- üîπ B·∫£ng danh s√°ch h·ªçc vi√™n -->
    <div class="table-responsive shadow-sm">
        <table class="table table-hover align-middle">
            <thead class="table-primary">
                <tr>
                    <th>H·ªç t√™n</th>
                    <th>Email</th>
                    <th>Kh√≥a h·ªçc</th>
                    <th>S·ªë b√†i ƒë√£ n·ªôp</th>
                    <th>ƒêi·ªÉm trung b√¨nh</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-center">Thao t√°c</th>
                </tr>
            </thead>

            <tbody id="studentTableBody">
                @if (Model != null && Model.Any())
                {
                    foreach (var s in Model)
                    {
                        string statusText = "";
                        string colorClass = "";

                        // √©p ki·ªÉu Enum ƒë·ªÉ x√°c ƒë·ªãnh tr·∫°ng th√°i
                        switch ((EnrollmentStatus)s.Status)
                        {
                            case EnrollmentStatus.Enrolled:
                                statusText = "ƒêang h·ªçc";
                                colorClass = "text-success fw-semibold";
                                break;
                            case EnrollmentStatus.Completed:
                                statusText = "Ho√†n th√†nh";
                                colorClass = "text-muted";
                                break;
                            case EnrollmentStatus.Dropped:
                                statusText = "Ngh·ªâ h·ªçc";
                                colorClass = "text-danger";
                                break;
                            default:
                                statusText = "Kh√¥ng r√µ";
                                colorClass = "text-secondary";
                                break;
                        }

                        <tr>
                            <td>@s.FullName</td>
                            <td>@s.Email</td>
                            <td>@s.CourseName</td>
                            <td>@($"{s.SubmittedCount}/{s.TotalAssignments}")</td>
                            <td>@s.AverageScore</td>
                            <td><span class="@colorClass">@statusText</span></td>
                            <td class="text-center">
                                <a asp-controller="StudentInstructor" asp-action="DetailStudent"
                                   asp-route-id="@s.Id" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            Ch∆∞a c√≥ h·ªçc vi√™n n√†o ƒë∆∞·ª£c ghi danh.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="~/js/Instructor/Student/Student.js" asp-append-version="true"></script>
}
