@{
    Layout = "_LayoutManager";
}

<div class="container-fluid py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0">Quản lý Khóa Học</h1>
        <div>
            <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCourse">Thêm Khoá Học</a>
        </div>
    </div>

    <div class="card border-0 shadow-sm bg-white">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="input-group w-50">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="courseSearch" type="search" class="form-control" placeholder="Tìm kiếm khoá học..." />
                </div>
                <div class="text-muted small">Tổng: <span id="courseCount">0</span></div>
            </div>

            <div class="listcourses">
                <!-- course cards sẽ được render bởi JS -->
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_ModalCourse")
@await Html.PartialAsync("_ModalCourseDetails")

@section Scripts {
    <script>
        let courses = [];
        let editingCourseId = null;
        let enrollingCourseId = null;
        
        window.tenantId = '@(ViewBag.TenantId ?? String.Empty)';

        async function loadCourses() {
            const container = $('.listcourses');
            container.html('<div class="text-center text-muted py-4">Đang tải...</div>');
            try {
                const res = await fetch('/api/courses');
                if (!res.ok) throw new Error('Không thể tải danh sách khóa học');
                courses = await res.json();
                $('#courseCount').text(courses.length || 0);
                renderCourses();
            } catch (err) {
                container.html('<div class="text-danger text-center">Lỗi khi tải dữ liệu</div>');
                console.error(err);
            }
        }

        function renderCourses() {
            const container = $('.listcourses');
            if (!courses || courses.length === 0) {
                container.html('<div class="text-center text-muted py-4">Không có khóa học</div>');
                $('#courseCount').text(0);
                return;
            }

            const q = ($('#courseSearch').val() || '').toLowerCase();
            const filtered = courses.filter(c => {
                if (!q) return true;
                const name = (c.name || '').toLowerCase();
                const instructor = ((c.instructor && c.instructor.fullName) || '').toLowerCase();
                return name.includes(q) || instructor.includes(q);
            });

            $('#courseCount').text(filtered.length);

            const cards = filtered.map(c => {
                const begin = c.beginTime ? new Date(c.beginTime).toLocaleDateString('vi-VN') : '-';
                const end = c.endTime ? new Date(c.endTime).toLocaleDateString('vi-VN') : '-';
                const instructor = (c.instructor && c.instructor.fullName) ? `${c.instructor.fullName}` : 'Chưa có';
                const enrolledCount = (c.enrollments ? c.enrollments.length : 0);
                return `
                    <div class="card mb-3">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-1">${escapeHtml(c.name)}</h5>
                                <p class="mb-1 text-muted small">${escapeHtml(instructor)} • ${begin} - ${end}</p>
                                <p class="mb-0 text-muted small">Đăng ký: ${enrolledCount}</p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm me-1" onclick="onView('${c.id}')">Xem</button>
                                <button class="btn btn-warning btn-sm me-1 text-dark" onclick="onEdit('${c.id}')">Sửa</button>
                                <button class="btn btn-danger btn-sm" onclick="onDelete('${c.id}')">Xóa</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');

            container.html(cards);
        }

        // Open details modal for a course
        async function onView(id) {
            try {
                const res = await fetch(`/api/courses/${id}`);
                if (!res.ok) throw new Error('Không thể tải chi tiết khóa học');
                const course = await res.json();

                $('#detailsCourseName').text(course.name || '');
                $('#detailsCourseInstructor').text((course.instructor && course.instructor.fullName) ? course.instructor.fullName : 'Chưa có');
                $('#detailsCourseBegin').text(course.beginTime ? new Date(course.beginTime).toLocaleDateString('vi-VN') : '-');
                $('#detailsCourseEnd').text(course.endTime ? new Date(course.endTime).toLocaleDateString('vi-VN') : '-');
                $('#detailsCourseDescription').text(course.description || '');

                const tbody = $('#detailsEnrolledBody');
                const enrollments = course.enrollments || [];
                if (enrollments.length === 0) {
                    tbody.html('<tr><td colspan="4" class="text-center text-muted">Chưa có học viên</td></tr>');
                } else {
                    const rows = enrollments.map(e => {
                        const student = e.student || e.user || {};
                        return `<tr data-enroll-id="${e.id || ''}">
                                    <td>${escapeHtml(student.fullName || student.name || 'Tên trống')}</td>
                                    <td>${escapeHtml(student.email || '')}</td>
                                    <td>${e.enrolledAt ? new Date(e.enrolledAt).toLocaleDateString('vi-VN') : '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="onRemoveEnrollment('${course.id}','${e.id || ''}')">Gỡ</button>
                                    </td>
                                </tr>`;
                    }).join('');
                    tbody.html(rows);
                }

                    // load tenant students into select when opening details modal
                    // load tenant students and exclude already-enrolled users
                    async function loadTenantStudents(excludeIds = []) {
                        try {
                            const res = await fetch('/api/users/students');
                            if (!res.ok) throw new Error('Không thể tải danh sách người dùng');
                            const students = await res.json();
                            const sel = $('#detailsStudentSelect');
                            sel.empty();
                            // filter out already enrolled users
                            const available = (students || []).filter(s => !excludeIds.includes((s.id || '').toString()));
                            if (!available || available.length === 0) {
                                sel.append(`<option value="">-- Không còn học viên để thêm --</option>`);
                                sel.prop('disabled', true);
                                $('#detailsEnrollBtn').prop('disabled', true);
                            } else {
                                sel.append(`<option value="">-- Chọn học viên hiện có trong tenant --</option>`);
                                available.forEach(s => sel.append(`<option value="${s.id}">${escapeHtml(s.fullName || s.fullName)} (${escapeHtml(s.email || '')})</option>`));
                                sel.prop('disabled', false);
                                $('#detailsEnrollBtn').prop('disabled', false);
                            }
                        } catch (err) {
                            console.error('loadTenantStudents error', err);
                            const sel = $('#detailsStudentSelect');
                            sel.empty().append(`<option value="">-- Lỗi khi tải người dùng --</option>`).prop('disabled', true);
                            $('#detailsEnrollBtn').prop('disabled', true);
                        }
                    }

                    // enrollment via this modal: enroll selected existing tenant student
                    $('#detailsEnrollBtn').off('click').on('click', async function () {
                        const selected = $('#detailsStudentSelect').val();
                        if (!selected) {
                            $('#detailsAlert').removeClass('d-none').text('Vui lòng chọn học viên.');
                            return;
                        }
                        try {
                            const enrollResp = await fetch('/api/courses/enrollments', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ courseId: course.id, userId: selected })
                            });
                            if (!enrollResp.ok) {
                                const txt = await enrollResp.text();
                                throw new Error(txt || enrollResp.statusText);
                            }

                            // refresh enrollments list
                            const updated = await (await fetch(`/api/courses/${course.id}`)).json();
                            const newEnrolls = updated.enrollments || [];
                            const newRows = newEnrolls.map(e => {
                                const student = e.student || e.user || {};
                                return `<tr data-enroll-id="${e.id || ''}">
                                            <td>${escapeHtml(student.fullName || student.name || 'Tên trống')}</td>
                                            <td>${escapeHtml(student.email || '')}</td>
                                            <td>${e.enrolledAt ? new Date(e.enrolledAt).toLocaleDateString('vi-VN') : '-'}</td>
                                            <td>
                                                <button class="btn btn-danger btn-sm" onclick="onRemoveEnrollment('${course.id}','${e.id || ''}')">Gỡ</button>
                                            </td>
                                        </tr>`;
                            }).join('');
                            $('#detailsEnrolledBody').html(newRows);
                            $('#detailsStudentSelect').val('');
                            $('#detailsAlert').addClass('d-none').text('');
                            showMessage('Thêm học viên vào khóa học thành công');
                            await loadCourses();
                        } catch (err) {
                            $('#detailsAlert').removeClass('d-none').text('Lỗi: ' + err.message);
                        }
                    });

                $('#detailsEditBtn').off('click').on('click', () => {
                    $('#modalCourseDetails').modal('hide');
                    onEdit(course.id);
                });
                $('#detailsDeleteBtn').off('click').on('click', () => {
                    $('#modalCourseDetails').modal('hide');
                    onDelete(course.id);
                });

                // prepare list of enrolled user ids to exclude from the select
                const enrolledIds = (course.enrollments || []).map(e => (e.student?.id || e.user?.id || e.userId || e.studentId || '').toString()).filter(x => x);
                await loadTenantStudents(enrolledIds);
                $('#modalCourseDetails').modal('show');
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }

        async function onRemoveEnrollment(courseId, enrollmentId) {
            if (!confirm('Bạn có chắc muốn gỡ học viên khỏi khóa học?')) return;
            if (!enrollmentId) {
                alert('Không thể gỡ học viên: enrollment id không hợp lệ.');
                return;
            }
            try {
                const res = await fetch(`/api/courses/enrollments/${enrollmentId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || res.statusText);
                }
                showMessage('Gỡ học viên thành công');
                await onView(courseId);
                await loadCourses();
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }

                // cleanup details modal
                $('#modalCourseDetails').on('hidden.bs.modal', () => {
                    $('#detailsAlert').addClass('d-none').text('');
                    $('#detailsEnrolledBody').html('');
                });

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>\"]+/g, function (s) {
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[s];
            });
        }

        function onEdit(id) {
            const course = courses.find(x => x.id === id);
            if (!course) return alert('Khóa học không tồn tại');
            editingCourseId = id;
            // Prefill modalCourse inputs
            $('#courseName').val(course.name);
            $('#courseDescription').val(course.description || '');
            if (course.beginTime) $('#beginTime').val(new Date(course.beginTime).toISOString().slice(0,10));
            if (course.endTime) $('#endTime').val(new Date(course.endTime).toISOString().slice(0,10));
            // set instructor select after instructor list loaded (modalHandler.js will populate)
            $('#modalCourse').on('shown.bs.modal.editprefill', () => {
                $('#instructorId').val(course.instructorId || '');
                $('#modalCourse').off('shown.bs.modal.editprefill');
            });
            // override submit to perform PUT
            $('#formAddCourse').off('submit').on('submit', async function (e) {
                e.preventDefault();
                const payload = {
                    id: editingCourseId,
                    name: $('#courseName').val(),
                    description: $('#courseDescription').val(),
                    beginTime: $('#beginTime').val(),
                    endTime: $('#endTime').val(),
                    instructorId: $('#instructorId').val(),
                    tenantId: tenantId
                };
                try {
                    const resp = await fetch('/api/courses', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) throw new Error(resp.statusText);
                    $('#modalCourse').modal('hide');
                    await loadCourses();
                    showMessage('Cập nhật khóa học thành công');
                } catch (err) {
                    $('#alertCourse').removeClass('d-none').text('Lỗi: ' + err.message);
                }
            });
            $('#modalCourse').modal('show');
        }

        function onDelete(id) {
            if (!confirm('Bạn có chắc muốn xóa khóa học này?')) return;
            fetch(`/api/courses/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (!res.ok) throw new Error(res.statusText);
                    showMessage('Xóa khóa học thành công', null);
                    loadCourses();
                }).catch(err => {
                    alert('Lỗi: ' + err.message);
                });
        }

        function onEnroll(id) {
            // Open details modal so manager can enroll an existing tenant student
            enrollingCourseId = id;
            onView(id);
            // focus the student select when modal opens
            $('#modalCourseDetails').one('shown.bs.modal', () => {
                $('#detailsStudentSelect').focus();
            });
        }

        function showMessage(message, redirect = null) {
            // reuse global showModal if available
            if (typeof showModal === 'function') {
                showModal(message, redirect);
                return;
            }
            alert(message);
            if (redirect) window.location.href = redirect;
        }

        // Reset modal overrides when closing modals so default handlers can work elsewhere
        $('#modalCourse').on('hidden.bs.modal', () => {
            editingCourseId = null;
            $('#formAddCourse').off('submit.courseEdit');
            $('#alertCourse').addClass('d-none').text('');
            // clear inputs
            $('#courseName').val('');
            $('#courseDescription').val('');
            $('#beginTime').val('');
            $('#endTime').val('');
            $('#instructorId').val('');
        });

        // no modalStudent handling here since creation is not available from this view

        // load on ready
        $(document).ready(() => {
            loadCourses();
            $('#courseSearch').on('input', () => renderCourses());
        });
    </script>
}